---
const SITE_URL = "https://shows.undershows.com.br";

// formata data
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("pt-BR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
}

// pega URL do poster
function getPosterUrl(show) {
  const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL ?? "";
  if (!STRAPI_URL) return null;

  const poster = show.poster;
  if (!poster) return null;

  const fmt = poster.formats?.medium || poster.formats?.small || poster;
  const url = fmt.url || poster.url;
  return url.startsWith("http") ? url : `${STRAPI_URL}${url}`;
}

// üîÅ gera todas as rotas /artist/<slug> em build time
export async function getStaticPaths() {
  const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL ?? "";

  if (!STRAPI_URL) {
    console.warn("PUBLIC_STRAPI_URL n√£o definido no ambiente.");
  }

  // helper de slug **local**, s√≥ pra esta fun√ß√£o
  function slugify(name) {
    return name
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");
  }

  const res = await fetch(
    `${STRAPI_URL}/api/shows?sort[0]=date:asc&pagination[page]=1&pagination[pageSize]=500&populate=poster`
  );
  const json = await res.json();
  const allShows = json.data ?? [];

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // bandSlug -> { name, shows[] }
  const bandsMap = new Map();

  for (const show of allShows) {
    const d = new Date(show.date);
    d.setHours(0, 0, 0, 0);
    if (d < today) continue; // s√≥ futuros

    const raw = show.bands || "";
    const bands = raw
      .split(",")
      .map((b) => b.trim())
      .filter(Boolean);

    for (const band of bands) {
      const s = slugify(band);
      if (!bandsMap.has(s)) {
        bandsMap.set(s, { name: band, shows: [] });
      }
      bandsMap.get(s).shows.push(show);
    }
  }

  return Array.from(bandsMap.entries()).map(([slug, info]) => ({
    params: { slug },
    props: {
      artistName: info.name,
      shows: info.shows,
    },
  }));
}

// props passados pelo getStaticPaths
const { artistName, shows } = Astro.props;

// helper S√ì pro template (n√£o usado no getStaticPaths)
function getBands(show) {
  const raw = show.bands || "";
  return raw
    .split(",")
    .map((b) => b.trim())
    .filter(Boolean);
}

const PAGE_TITLE = `Shows com ${artistName} | Undershows`;
---
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>{PAGE_TITLE}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/images/icons/icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icons/icon-192x192-v2.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/images/icons/icon-512x512-v2.png">
    <link rel="manifest" href="/manifest.json">

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        min-height: 100vh;
        color: #000;
        display: flex;
        justify-content: center;
        background-image: radial-gradient(ellipse at center, #f05291, gray);
      }

      main {
        width: 100%;
        max-width: 900px;
        padding: 24px 16px 48px;
        text-align: center;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      .logo {
        width: 160px;
        max-width: 50vw;
        margin: 0 auto 16px;
        display: block;
      }

      h1 {
        margin: 0 0 8px;
        font-size: 1.4rem;
      }

      .subtitle {
        margin: 0 0 16px;
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 16px;
        font-size: 0.9rem;
        font-weight: 700;
        text-decoration: underline;
      }

      .shows {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .show-card {
        text-align: center;
        margin: 0 auto 12px;
        max-width: 460px;
      }

      .show-title {
        margin: 6px 0 4px;
        font-weight: 800;
        font-size: 1.1rem;
      }

      .show-info {
        margin: 0 0 4px;
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .show-bands {
        margin: 0 0 8px;
        font-size: 0.9rem;
      }

      .poster-wrapper {
        display: block;
        border-radius: 12px;
        overflow: hidden;
        max-width: 460px;
        margin: 0 auto;
      }

      .show-poster {
        width: 100%;
        display: block;
      }

      .ticket-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px 0;
        background: #000;
        color: #f5f5f5;
        font-weight: 800;
        font-size: 0.98rem;
        border: none;
        cursor: pointer;
      }

      .ticket-btn + .ticket-btn {
        border-top: 1px solid #333;
      }

      .ticket-btn .emoji {
        font-size: 1.6rem;
        line-height: 1;
      }

      .ticket-btn:hover {
        background: #222;
      }

      .empty {
        margin-top: 24px;
        font-size: 0.95rem;
      }
    </style>
  </head>

  <body>
    <main>
      <a href="/">
        <picture>
          <source srcset="https://assets.undershows.com.br/logo-undershows.webp" type="image/webp" />
          <img
            src="https://assets.undershows.com.br/logo-undershows.png"
            alt="Undershows"
            class="logo"
          />
        </picture>
      </a>

      <a href="/" class="back-link">‚Üê Ver todos os shows</a>

      <h1>Shows com {artistName}</h1>
      <p class="subtitle">Rol√™s futuros que t√™m essa banda no line-up.</p>

      {shows.length === 0 && (
        <p class="empty">
          Ainda n√£o tem nenhum show futuro cadastrado com <strong>{artistName}</strong>.
        </p>
      )}

      {shows.length > 0 && (
        <section class="shows">
          {shows.map((show) => {
            const posterUrl = getPosterUrl(show);
            const hasTicket = !!show.ticket_link;
            const shareUrl = `${SITE_URL}/cartaz/${show.id}`;

            return (
              <article class="show-card">
                <h2 class="show-title">{show.title}</h2>
                <p class="show-info">
                  {formatDate(show.date)} ‚Äî {show.city}/{show.state}
                </p>

                {getBands(show).length > 0 && (
                  <p class="show-bands">
                    {getBands(show).join(" / ")}
                  </p>
                )}

                <div class="poster-wrapper">
                  {posterUrl && (
                    <img
                      src={posterUrl}
                      alt={show.title}
                      class="show-poster"
                      loading="lazy"
                    />
                  )}

                  {hasTicket && (
                    <a
                      class="ticket-btn"
                      href={show.ticket_link}
                      target="_blank"
                    >
                      <span class="emoji">üéüÔ∏è</span>Comprar Ingressos
                    </a>
                  )}

                  <button
                    type="button"
                    class="ticket-btn"
                    data-share-show
                    data-title={show.title}
                    data-date={formatDate(show.date)}
                    data-city={show.city}
                    data-state={show.state}
                    data-share-url={shareUrl}
                  >
                    <span class="emoji">üì§</span>Divulgar o rol√™
                  </button>
                </div>
              </article>
            );
          })}
        </section>
      )}
    </main>

    <script>
      (function () {
        async function shareShowFromButton(btn) {
          const title = btn.dataset.title;
          const date = btn.dataset.date;
          const city = btn.dataset.city;
          const state = btn.dataset.state;
          const shareUrl = btn.dataset.shareUrl || "https://shows.undershows.com.br";

          const text =
`${title}
${date} - ${city}/${state}

via Undershows: ${shareUrl}`;

          try {
            if (navigator.share) {
              await navigator.share({ text });
            } else if (navigator.clipboard) {
              const fullText =
`${title}
${date} - ${city}/${state}

Cartaz: ${shareUrl}

via Undershows: https://shows.undershows.com.br`;
              await navigator.clipboard.writeText(fullText);
              alert("Link copiado! Cole no WhatsApp/Instagram ü§ò");
            } else {
              alert("Copie e cole:\n\n" + text + "\n\nCartaz: " + shareUrl);
            }
          } catch (err) {
            console.error("Erro ao compartilhar", err);
          }
        }

        document.addEventListener("click", function (ev) {
          const btn = ev.target.closest("[data-share-show]");
          if (!btn) return;
          ev.preventDefault();
          shareShowFromButton(btn);
        });
      })();
    </script>
  </body>
</html>
