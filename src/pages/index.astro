---
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL;

const states = [
  "SP", "AC", "AL", "AM", "AP", "BA", "CE", "DF", "ES",
  "GO", "MA", "MG", "MS", "MT", "PA", "PB", "PE", "PI",
  "PR", "RJ", "RN", "RO", "RR", "RS", "SC", "SE", "TO"
];

const res = await fetch(
  `${STRAPI_URL}/api/shows?sort[0]=date:asc&pagination[page]=1&pagination[pageSize]=500&populate=poster`
);
const json = await res.json();
const allShows = json.data ?? [];

const today = new Date();
today.setHours(0, 0, 0, 0);

const shows = allShows.filter((show) => {
  const d = new Date(show.date);
  d.setHours(0, 0, 0, 0);
  return d >= today;
});

function getPosterUrl(show) {
  const poster = show.poster;
  if (!poster) return null;

  const fmt = poster.formats?.medium || poster.formats?.small || poster;
  const url = fmt.url || poster.url;
  return url.startsWith("http") ? url : `${STRAPI_URL}${url}`;
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("pt-BR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
}
---

<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Undershows</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/images/icons/icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icons/icon-192x192-v2.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/images/icons/icon-512x512-v2.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Undershows">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" as="image" href="https://undershows.nyc3.cdn.digitaloceanspaces.com/logo-undershows.webp" />

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        min-height: 100vh;
        color: #000;
        display: flex;
        justify-content: center;
        background-image: radial-gradient(ellipse at center, #f05291, gray);
      }

      main {
        width: 100%;
        max-width: 900px;
        padding: 24px 16px 48px;
        text-align: center;
      }

      .logo {
        width: 180px;
        max-width: 50vw;
        margin: 0 auto 24px;
        display: block;
      }

      .states-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 6px;
        margin: 0 auto 20px;
        max-width: 320px; /* controla quantos cabem por linha no mobile */
      }

      .state-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;        /* mais estreito ‚Üí cabe 6‚Äì7 por linha */
        height: 32px;
        border-radius: 8px;
        border: 2px solid #ff7da8;
        background: #ff4b92;
        color: #000;
        font-weight: 600;
        font-size: 0.8rem;
        text-decoration: none;
        transition:
          transform 0.1s ease,
          box-shadow 0.1s ease,
          background 0.1s ease,
          border-color 0.1s ease;
        box-shadow: 0 2px 0 rgba(0, 0, 0, 0.25);
      }

      .state-btn--active {
        background: #ff4b92;
        border-color: #000;
        border-width: 3px;
        font-weight: 800;
      }

      .state-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.4);
      }

      @media (min-width: 600px) {
        .states-grid {
          max-width: 480px;
          gap: 8px;
          margin-bottom: 24px;
        }

        .state-btn {
          width: 56px;
          height: 36px;
          font-size: 0.9rem;
        }
      }

      .footer-text {
        margin-top: 16px;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .footer-text a {
        color: #000;
        font-weight: 700;
        text-decoration: none;
      }

      .footer-text a:hover {
        text-decoration: underline;
      }

      .shows {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .show-card {
        text-align: center;
        margin: 0 auto 12px;
        max-width: 460px;
      }

      .show-title {
        margin: 6px 0 4px;
        font-weight: 800;
        font-size: 1.1rem;
      }

      .show-info {
        margin: 0 0 12px;
        font-size: 0.95rem;
        opacity: 0.9;
      }

      .poster-wrapper {
        display: inline-block;
        border-radius: 12px;
        overflow: hidden;
      }

      .show-poster {
        width: 100%;
        max-width: 460px;
        display: block;
      }

      .ticket-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px 0;
        background: #000;
        color: #f5f5f5;
        font-weight: 800;
        text-decoration: none;
        font-size: 0.98rem;
        border: none;
        margin: 0;
      }

      .ticket-btn:hover {
        background: #222;
      }

      .ticket-btn .emoji {
        font-size: 1.6rem;
        line-height: 1;
        display: flex;
        align-items: center;
      }

      .empty {
        font-weight: bold;
        margin-top: 8px;
      }
    </style>
  </head>

  <body>
    <main>
      <picture>
        <source srcset="https://undershows.nyc3.cdn.digitaloceanspaces.com/logo-undershows.webp" type="image/webp" />
        <img
          src="https://undershows.nyc3.cdn.digitaloceanspaces.com/logo-undershows.png"
          alt="Undershows"
          class="logo"
          width="180"
          height="180"
        />
      </picture>

      <div class="states-grid">
        {states.map((uf) => (
          <a
            href={`/?state=${uf}`}
            class="state-btn"
            data-state={uf}
          >
            {uf}
          </a>
        ))}
      </div>

      <section class="shows">
        {shows.map((show) => {
          const posterUrl = getPosterUrl(show);
          const hasTicket = !!show.ticket_link;

          return (
            <article class="show-card" data-state={show.state}>
              <h2 class="show-title">{show.title}</h2>
              <p class="show-info">
                {formatDate(show.date)} ‚Äî {show.city}/{show.state}
              </p>

              <div class="poster-wrapper">
                {posterUrl && (
                  <img
                    src={posterUrl}
                    alt={show.title}
                    class="show-poster"
                    loading="lazy"
                  />
                )}

                {hasTicket && (
                  <a
                    class="ticket-btn"
                    href={show.ticket_link}
                    target="_blank"
                    rel="noreferrer"
                  >
                    <span class="emoji">üéüÔ∏è</span>Comprar Ingressos
                  </a>
                )}
              </div>
            </article>
          );
        })}
      </section>

      <p id="no-shows" class="empty" style="display:none;">
        Nenhum show neste estado.
      </p>

      <div class="footer-text">
        <p>
          Cartazes de shows, s√≥ mandar por email:
          <a href="mailto:undershowsbr@gmail.com">undershowsbr@gmail.com</a>
        </p>
        <p>
          Curte vinil?
          <a href="https://undershows.com.br" target="_blank">undershows.com.br</a>
        </p>
      </div>
    </main>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const current = params.get("state") || "SP";

        document.querySelectorAll(".state-btn").forEach((el) => {
          const uf = el.getAttribute("data-state");
          if (uf === current) {
            el.classList.add("state-btn--active");
          } else {
            el.classList.remove("state-btn--active");
          }
        });

        let visibleCount = 0;
        document.querySelectorAll(".show-card").forEach((card) => {
          const uf = card.getAttribute("data-state");
          if (!current || uf === current) {
            card.style.display = "";
            visibleCount++;
          } else {
            card.style.display = "none";
          }
        });

        const noShows = document.getElementById("no-shows");
        if (noShows) {
          noShows.style.display = visibleCount === 0 ? "" : "none";
        }
      })();
    </script>
  </body>
</html>
